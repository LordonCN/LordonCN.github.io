---
layout: post
title: "[小冬搞开发]-基础篇-飞控开发系列(四)"
subtitle: '小冬搞机之数据处理部分'
author: "Lordon"
header-img: img/jassica/jessica-jung.jpg
catalog: true
tags:
  - Quadcopter
  - [小冬搞开发]
---
# 关于本文
上一篇中使用blender对m100结构等进行了精确设计,各个零件的导出文件以及[设计工程已经放在了Github](https://github.com/Tcloser/NEU_M100_description),算是整合了好几个工程中有用的部分,后面会跟[同伴](https://github.com/orgs/NEU-ROS-packages-for-DJI-M100-drone/people/fei0511)创建Organizations将工程一起放进去[Github](https://github.com/NEU-ROS-packages-for-DJI-M100-drone?type=source).

## 需要处理的数据
odom:<br>
1 position(x,y,z)<br>
2 pose(x,y,z,w)<br>
3 drone body(线速度+角速度)(x,y,z)<br>

trajectony:<br>
destination (x,y,z)<br>

----
<center>总结一下流程</center>
odom+trajectony->lee_position_control->mottor_speed(angle)(vx,vy,vz)

## 保存ros话题数据

1 - /src同目录下创建/bagfile,并cd进入<br>
2 - 启动launch文件同时保存所有话题数据<br>

```
$ rosbag record -a  + $ roslaunch rotors_gazebo neu_m100_start.launch
	或者只保存部分
$ rosbag record /NEU_m100/imu /NEU_m100/gps /NEU_m100/motor_speed
```

3 - 查看数据包属性<br>
```
$ rosbag info 2020-03-07-09-16-24.bag

dynamic_reconfigure/Config              [958f16a05573709014982821e6822580]
dynamic_reconfigure/ConfigDescription   [757ce9d44ba8ddd801bb30bc456f946f]
gazebo_msgs/LinkStates                  [48c080191eb15c41858319b4d8a609c2]
gazebo_msgs/ModelStates                 [48c080191eb15c41858319b4d8a609c2]
geometry_msgs/PointStamped              [c63aecb41bfdfd6b7e1fac37c7cbe7bf]
geometry_msgs/Pose                      [e45d45a5a1ce597b249e23fb30fc871f]
geometry_msgs/PoseWithCovarianceStamped [953b798c0f514ff060a53a3498ce6246]
geometry_msgs/TransformStamped          [b5764a33bfeb3588febc2682852579b0]
geometry_msgs/TwistStamped              [98d34b0043a2093cf9d9345ab6eef12e]
......
```

4 - 转换成txt保存[这里使用脚本solve_data.sh]<br>
```
$ rostopic echo -b 2020-03-07-09-16-24.bag -p geometry_msgs/Pose > m100_data.txt
```
试想如果执行这条指令多快?这样就能保存多个话题数据了耶
```
$ rostopic echo -b 2020-03-07-09-16-24.bag -p geometry_msgs/Pose geometry_msgs/PointStamped ... > m100_data.txt
```

<center>you may only specify one input topic</center>

> 因为$rostopic echo..这指令一次只能对一个话题数据进行处理,我这十多个话题每次都这么搞岂不是麻烦死? 

## shell脚本处理

1 - 目录下创建sove_data.sh,使用vscode编写<br>
```
touch sove_data.sh
```
2 - ctrl+shift+c调出命令行窗口运行之前要改权限<br>
```
$ chmod +x sove_data.sh
```
3 - 运行<br>
```
$ ./sove_data.sh
```

-----------------

CODE solve_data.sh:
```
#! /bin/bash
ls -a
echo -e "Pls input the name of bag : \c "
read filename
echo output /NEU_m100/gps
rostopic echo -b $filename -p /NEU_m100/gps > $PWD/data/gps.txt
echo output /NEU_m100/imu
rostopic echo -b $filename -p /NEU_m100/imu > $PWD/data/imu.txt
......

```

## txt数据处理

Ros保存的话题数据从`.bag`中提取出来之后所有数据均用逗号分隔开,所以这里关键用到`readlines`和`split`语句.一个是逐行读入数据为列表,一个是按指定方式将列表元素进行拆分成新的元素.

```python
class Trajectory():
    def __init__(self,
        trajectory_fileName      = 'trajectory.txt',
        trajectory_time          = [],
        trajectory_seq           = [],
        trajectory_stamp         = [],
        trajectory_translation_x = [],
        trajectory_translation_y = [],
        trajectory_translation_z = []):

        self.trajectory_fileName      = trajectory_fileName
        self.trajectory_time          = trajectory_time   # 时间
        self.trajectory_seq           = trajectory_seq
        self.trajectory_stamp         = trajectory_stamp # 时间戳
        self.trajectory_translation_x = trajectory_translation_x  # 轨迹变换x
        self.trajectory_translation_y = trajectory_translation_y  # 轨迹变换y
        self.trajectory_translation_z = trajectory_translation_z  # 轨迹变换z

    def loadTrajectoryDataSet(self, trajectory_fileName):
        with open(trajectory_fileName, 'r') as f:
            data = f.readlines()  # txt中所有字符串读入data sum=14814

            for line in data:
                trajectory = line.strip().split(',')  # 将数据拆分易存储

                self.trajectory_time.append(trajectory[0])
                self.trajectory_seq.append(trajectory[1])
                self.trajectory_stamp.append(trajectory[2])
                self.trajectory_translation_x.append(trajectory[5])
                self.trajectory_translation_y.append(trajectory[6])
                self.trajectory_translation_z.append(trajectory[7])
        return 0

```
这里`trajectory_`变量定义太多,重复性复制粘贴特别麻烦,使不使用init初始化在后面确实没啥大的差别,但是为了[规范代码](https://blog.csdn.net/geerniya/article/details/77487941),还是费力少点bug.


# 附件
## 东大地理参数

```
https://www.ngdc.noaa.gov/geomag/calculators/magcalc.shtml#igrfwmm
东北大学
gps_update_freq="5.0"
lat:41° 45' 57"  lon:123° 25' 30" 
latitude=41.765833 
longitude=73.984000 
alt=50
reference_magnetic_field_north="0.26764"
reference_magnetic_field_east="-0.04413"
reference_magnetic_field_down="0.47029"
```
